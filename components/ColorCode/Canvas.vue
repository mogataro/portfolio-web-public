<template lang="pug">
canvas#cvs(
  :width="`${moveDistance}px`"
  :height="`${cvsh}px`"
)
</template>
<script>
export default {
  name: 'Canvas',
  props: {
    color: {
      type: String,
      default: '#00FF00'
    }
  },
  data() {
    return {
      cvsw: window.innerWidth,
      cvsh: 300,
      flowImage: null,
      fallImage: new Image()
    }
  },
  computed: {
    moveDistance() {
      return this.cvsw - 50
    }
  },
  watch: {
    cvsw() {
      this.drawCreative()
    },
    color() {
      this.drawCreative()
    }
  },
  mounted() {
    setInterval(window.addEventListener('resize', this.handleResize), 50)
    this.drawCreative()
  },
  beforeDestroy() {
    setInterval(window.removeEventListener('resize', this.handleResize), 50)
  },
  methods: {
    drawCreative() {
      let canvas = document.getElementById('cvs')
      let ctx = canvas.getContext('2d')
      let imgCnt = 30 // 描画する画像の数
      let aryImg = [] // 画像の情報を格納
      let cvsw = this.cvsw // canvasタグに指定したwidth
      let cvsh = this.cvsh // canvasタグに指定したheight
      let imgBaseSizeW = 30 // 画像の基本サイズ横幅
      let imgBaseSizeH = 20 // 画像の基本サイズ立幅
      let aspectMax = 1.5 // アスペクト比計算時の最大値
      let aspectMin = 0.5 // アスペクト比計算時の最小値
      let speedMax = 1 // 落下速度の最大値
      let speedMin = 0.5 // 落下速度の最小値
      let angleAdd = 2 // 画像角度への加算値

      // 画像の読み込み
      let img = this.fallImage
      let color = this.color
      let svg = `<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="100" height="100" viewBox="0 0 26.458333 26.458333" version="1.1" id="svg8" inkscape:version="0.92.2 5c3e80d, 2017-08-06" sodipodi:docname="sakura.svg"><g transform="translate(-25.762198,-238.82032)"><g><path style="fill:${color};stroke-width:0.26458332" d="m 27.260298,261.65097 c -0.0706,0.009 0.07432,0.0122 0,0 z" /><path style="fill:${color};stroke-width:0.26458332" d="m 42.065638,247.3716 c 0.0096,1.71169 -0.425804,3.68254 -1.946297,4.6827 -1.188997,0.66536 -2.469783,-0.31012 -2.939218,-1.40526 -1.12856,-2.08003 -0.822347,-4.61979 -0.01145,-6.74946 0.573286,-1.18883 2.348668,-1.95532 3.411066,-0.94473 1.097111,1.17855 1.47214,2.84922 1.485896,4.41675 z" /><path style="fill:${color};stroke-width:0.26458332" d="m 39.660214,250.24474 c -0.330719,1.33551 -1.88715,-0.66207 -0.345588,-0.43479 0.188294,0.0567 0.354454,0.22929 0.345588,0.43479 z"  /><path style="fill:${color};stroke-width:0.26458332" d="m 48.212839,252.44972 c -0.532283,1.61213 -2.420083,2.08333 -3.933924,2.10976 -1.735727,0.0278 -3.779727,0.003 -5.015036,-1.41663 -0.810905,-1.23753 0.813956,-2.25645 1.867693,-2.48956 2.016661,-0.63116 4.292995,-0.41863 6.176059,0.52391 0.453743,0.27442 0.890955,0.70846 0.905208,1.27252 z"  /><path style="fill:${color};stroke-width:0.26458332" d="m 39.660213,252.7838 c -0.567929,1.67337 -2.533879,2.15011 -4.109902,2.17548 -1.81751,0.029 -3.955737,-2.1e-4 -5.253324,-1.47954 -0.73869,-1.15238 0.64153,-2.16488 1.643182,-2.43162 2.100342,-0.78606 4.511356,-0.58346 6.54724,0.29618 0.560545,0.28599 1.147366,0.75637 1.172804,1.4395 z"  /><path style="fill:${color};stroke-width:0.26458332" d="m 39.130139,253.44103 c -0.224028,0.42879 -1.312519,1.44839 -0.872828,1.22128 -0.175897,0.30055 -0.825318,1.46425 -0.519791,0.52461 -0.181122,-0.60068 -0.118623,0.86213 -0.625661,0.90642 -0.943332,0.61615 -1.214375,1.68505 -1.498525,2.69917 0.301045,-0.59523 -0.460628,1.42556 -0.22409,0.81613 -0.154333,0.77357 0.415467,2.19261 -0.262099,2.54565 -0.8062,0.025 -0.877703,-1.10717 0.05357,-0.78837 0.388452,0.045 0.459455,0.23047 0.01204,0.0617 -0.303146,0.18657 0.858886,-0.41189 0.840174,-0.14305 -0.251806,-0.1303 -0.73,0.29127 -0.288492,-0.0867 -0.514292,0.38624 0.685537,-0.52398 0.07979,-0.0371 0.432858,-0.1969 1.19568,-1.26002 1.239451,-1.33524 0.261782,-0.4007 0.546823,-0.66749 0.523525,-0.72138 0.72118,-0.7173 0.790725,-1.59605 0.899612,-2.51292 0.351488,-0.61705 0.04252,-2.03008 0.460596,-2.21953 -0.175049,0.45482 -0.393442,-1.34485 0.390027,-1.3866 0.859651,-0.41858 1.076722,0.98158 0.830048,0.96485 0.318219,0.48977 -0.25566,1.06063 -0.09617,0.96687 0.0899,0.94486 -0.323122,2.28626 -0.357468,2.86933 -0.177048,0.44425 -0.390636,1.56407 -0.973194,2.09057 -0.630395,0.57552 -0.828909,1.34779 -1.53113,1.89206 -0.12279,0.15111 -0.958298,0.71291 -0.42302,0.26009 -0.0073,0.27553 -0.974634,0.66978 -0.974209,0.41332 1.14855,0.13871 -1.838595,0.38273 -0.512098,0.23296 0.611093,-0.92486 -1.432406,-0.22366 -1.06011,-0.34953 -0.390007,-1.03139 -0.286426,-2.25481 -0.04043,-3.29121 -0.324368,0.61387 0.284742,-1.38976 0.217269,-0.81247 0.117569,-1.23727 0.783721,-2.43412 1.750752,-3.20014 0.633084,-0.33553 0.16347,0.9635 0.219588,0.0762 0.03835,-0.57544 1.068007,-1.49221 0.730354,-1.13085 0.153492,-0.99732 1.185135,-1.64493 1.883049,-0.63074 l 0.12941,0.10459 z"  /><path style="fill:${color};stroke-width:0.26458332" d="m 39.622185,254.52563 c -0.602896,1.15251 -1.139409,2.33553 -1.60443,3.54802 -0.165981,0.48954 -1.099929,1.68185 -1.04492,1.60174 0.308521,0.10469 -0.77529,1.71305 -0.877271,0.80125 -1.218911,-0.44851 -0.816077,-1.77984 -0.390114,-2.63726 0.08367,-0.40017 0.563531,-0.91517 0.399771,-0.8116 0.224401,-0.54314 0.375597,-1.24917 0.663657,-1.46287 -0.09658,-0.39093 0.455081,-0.8853 0.130244,-0.16968 0.05675,-0.47257 0.128269,-0.61473 0.173458,-0.71413 0.201528,-0.33952 0.09259,0.36874 0.127848,-0.3194 0.115998,-0.47334 0.543734,-0.98862 0.471218,-0.93789 0.282578,-0.43871 -0.161154,0.4938 0.112097,-0.2507 0.374201,-0.42772 -0.159732,0.34044 0.23912,-0.31258 1.269381,-0.62548 1.661062,1.23518 1.204651,2.11737 -0.341789,0.92447 -0.429685,1.90656 -0.810849,2.81457 -0.390501,0.9222 -0.974324,1.79965 -1.725416,2.45572 0.189735,0.0924 -0.985559,1.48825 -0.641069,0.77215 -0.299893,1.57886 -2.164379,-0.44463 -1.048221,-1.26472 0.756956,-1.29057 0.83185,-2.95086 1.712187,-4.14379 -0.2601,0.65789 0.491527,-0.88758 0.08777,0.14042 -0.336769,-0.43525 1.063385,-0.95558 1.217293,-0.0328 0.494665,1.05325 -0.685066,1.8703 -0.930263,2.85101 -0.442026,0.76968 -1.109431,2.43897 -0.919489,2.28618 0.142277,1.18544 -1.440502,-0.56379 -1.413261,0.48296 0.358452,0.7613 1.62869,-0.60698 0.962443,0.47913 0.677969,0.97488 -1.083213,1.25724 -1.403905,0.3924 -0.392808,-0.90498 0.864146,-1.99931 1.403584,-0.91701 -0.177557,1.42356 -2.325646,0.12827 -1.088228,-0.64659 0.859715,-0.67671 1.242613,1.72912 0.892328,1.11164 0.203479,-0.64297 0.603864,1.27732 -0.258057,0.93827 -1.211235,0.62661 -0.843115,-1.68384 -0.653666,-1.57818 -0.333895,-0.2061 0.646389,-1.45194 1.234509,-0.57753 0.859528,1.33073 -1.432398,0.37401 -1.037386,0.33216 0.09537,-0.47969 0.129817,0.43754 0.04635,-0.19816 0.07491,-0.87308 0.523211,-1.71144 0.891486,-2.48053 0.503172,-0.73162 0.507651,-1.71878 1.086759,-2.42242 0.280355,0.75637 1.404051,0.27787 1.285395,-0.0933 0.05614,0.51005 -0.660314,1.07559 -0.137922,0.30508 -0.05976,0.10448 -0.295058,0.73283 -0.107406,0.24423 -0.547484,1.29007 -0.956086,2.632 -1.368578,3.96666 -0.188685,0.82833 -1.175658,0.8728 -1.646093,0.73803 -0.196682,1.02869 -0.04421,-0.95722 0.522072,-1.06186 0.422189,-0.79004 1.238456,-1.53911 1.698282,-2.40045 0.191796,-0.52576 0.463346,-1.93604 0.517464,-1.68323 0.350183,-0.7397 0.04579,-1.74555 0.557184,-2.32339 0.309857,0.23307 1.022849,0.34762 0.98401,0.0675 -0.394704,0.81162 0.07294,-0.51911 -0.174844,0.3455 -0.148017,0.47044 0.018,-0.55701 -0.166782,0.16211 -0.06355,0.25265 -0.137623,0.25864 -0.266671,0.65707 0.04392,-0.70484 -0.24604,1.3904 -0.32945,0.32533 0.309272,0.35404 -0.375743,1.12751 -0.148638,0.3422 0.275511,0.20056 -0.306047,1.31215 -0.205448,0.6139 0.139589,0.52208 -0.489461,0.93158 -0.146746,0.20252 0.110584,0.41488 -0.317968,1.12569 -0.300852,0.89393 -0.158681,1.03053 -0.645668,1.94931 -0.741741,2.9996 -0.63618,1.13966 -2.038004,-0.43279 -0.756089,-0.98282 0.249214,-0.22121 0.489785,-0.51657 0.03636,-0.18329 0.798135,-1.34097 1.445026,-2.7646 1.908377,-4.25074 0.3421,-0.90546 1.186334,-0.44007 1.777883,-0.13166 z"  /><path style="fill:${color};stroke-width:0.26458332" d="m 41.058525,253.62417 c 1.249432,0.24726 1.807067,1.53553 2.601636,2.38745 0.596947,0.91468 1.160761,1.86573 1.586162,2.86985 0.135071,0.75491 -0.02937,-0.39068 0.133909,0.30296 0.45639,0.55745 0.08348,1.60365 0.04147,1.01499 0.788426,0.33003 0.05263,2.28536 -0.202655,1.7111 -0.03217,-1.0132 0.03878,1.15873 -0.770677,0.76537 -1.374431,-0.10715 -1.76385,-1.6356 -2.560005,-2.51072 -0.81834,-0.78447 -1.383208,-1.81177 -1.746048,-2.86987 -0.505176,-0.93649 -0.676472,-2.01839 -0.815774,-3.0563 -0.10486,-1.3639 1.40083,-1.32174 2.249395,-0.81764 0.243125,0.0671 1.097918,0.50031 0.387763,0.28675 0.378399,0.12498 1.794807,0.45716 0.691344,0.29102 0.469971,0.70931 0.872302,0.0607 1.379336,0.79987 0.392282,0.29418 0.750319,0.6926 0.714228,0.65147 0.332094,0.39618 -0.423355,-0.43112 0.107596,0.0767 0.755584,0.48163 1.131202,1.65679 1.191297,2.19617 0.206399,0.81534 0.199435,1.79666 0.179726,2.89625 0.205332,0.8763 -0.437429,1.18309 -1.192686,1.17634 -0.203908,0.32298 -1.552466,-0.6282 -1.834521,-1.24287 -1.088629,-1.21639 -1.611869,-2.8026 -1.994441,-4.35848 -0.01003,-0.30654 0.313449,0.56885 -0.01249,-0.0987 -0.200122,-0.49691 -0.140131,0.24194 -0.01682,-0.2766 0.522242,-0.5233 1.474685,-0.0316 1.247149,0.26244 0.31936,0.0106 0.453772,0.72786 0.166269,0.17312 0.459927,1.04583 -1.762127,1.15474 -1.688072,0.001 -1.115333,-0.70981 0.311771,-2.2443 1.242036,-1.49367 0.450687,0.23658 0.833141,0.81695 0.139061,0.30792 0.518532,-0.1228 1.291574,0.80661 1.679026,1.2455 0.122207,0.0749 0.209611,0.67898 0.05348,0.13057 0.342463,0.349 0.583266,1.60267 0.417155,0.81774 0.269458,0.63846 0.362121,0.74849 0.67906,1.55512 0.230584,0.63922 -0.105292,0.43786 0.07776,0.39452 0.133993,0.13081 0.199392,0.39987 0.02806,0.77359 0.0094,-0.91331 0.41675,1.35177 0.12062,0.48933 -0.158009,-0.87991 0.613088,0.78384 0.09316,0.10006 -0.49838,0.4352 -1.389103,0.6297 -1.037183,-0.33256 0.157466,-1.04467 -0.304965,-2.01177 -0.672795,-2.93464 0.39826,-0.94286 1.787439,-0.79341 1.881354,0.29566 0.486189,0.96547 -0.607605,1.00033 -1.057678,0.37149 -0.220087,0.65501 -0.728083,-0.62232 -0.854222,-1.08806 0.431606,-1.27811 1.792923,-0.16572 1.657411,0.81507 0.34893,1.01875 0.734194,2.17416 0.44421,3.26515 -0.280051,1.34319 -1.703387,0.60563 -1.66792,-0.43475 -0.111379,-0.71409 0.377632,0.89808 -0.165208,-0.12431 -0.179397,-0.20822 0.03906,-1.01028 0.172278,-0.3755 -0.183602,-0.45423 -0.664944,-1.38539 -0.784221,-2.10405 0.388694,0.8657 -0.328566,-0.46163 -0.222377,-0.22531 -0.212031,-0.67925 0.194723,0.12648 -0.162589,-0.39845 -0.09099,-0.0761 -0.288647,-0.61847 -0.08044,-0.16155 -0.325425,-0.4888 0.207877,0.25952 -0.328201,-0.31822 -0.495942,-0.49034 -0.126396,-0.45437 -0.755292,-0.65617 -0.154093,-0.10572 -0.467297,-0.43868 -0.127748,-0.0478 -0.885228,-0.0126 -1.614488,-1.0955 -0.416044,-1.39628 0.628083,0.2025 1.019678,1.05298 1.405348,1.53421 -0.07409,1.02913 -1.475026,1.25944 -1.608279,0.1047 -0.224814,-0.73137 0.690416,-0.90377 1.103911,-1.06566 0.420619,0.37448 0.310481,0.75603 0.08511,0.0501 0.776767,1.29334 0.932575,2.91083 1.919387,4.10291 0.20744,0.45512 1.21026,1.11892 1.134913,1.22953 -0.847925,-0.21044 1.015289,-0.0252 0.04414,0.24739 -0.566503,0.40728 -0.558284,-0.38506 -0.363472,-0.0673 -0.34518,-0.10887 0.0091,-1.66037 -0.12611,-2.24774 -0.06361,-0.67482 -0.537938,-1.96816 -0.719654,-1.88189 -0.248297,-0.38727 -0.05636,-0.0499 -0.461338,-0.47796 0.129653,0.0364 -1.366822,-0.90742 -1.239605,-1.17162 0.702745,0.0162 0.50017,0.44392 -0.09118,0.13443 -0.313376,-0.40988 -1.705144,-0.44818 -2.031159,-0.82351 0.608016,-0.9305 0.594919,0.629 0.735365,1.30779 0.486958,1.47796 1.163538,2.92097 2.262393,4.04629 0.245537,0.64384 1.095466,1.29326 1.217699,1.73154 -0.450163,-0.11502 -0.711103,0.31025 -0.271156,-0.0709 0.221353,0.52148 -0.335254,1.13234 -0.126642,0.23181 -0.183273,-0.84012 0.837798,-0.55141 0.520225,-0.34838 -0.642568,-0.42278 -0.394814,-1.79426 -0.654561,-2.06577 -0.03801,0.13779 -0.666398,-1.07701 -0.90159,-1.48236 -0.42638,-0.9191 -0.996862,-1.5624 -1.715847,-2.26436 -0.776082,-0.42725 -1.794558,-1.23977 -0.44929,-1.75963 l 0.135558,-0.0965 z" /></g></g></svg>`
      img.src = 'data:image/svg+xml;base64,' + btoa(svg)
      img.onload = flow_start

      // 画像のパラメーターを設定
      function setImagas() {
        let aspect = 0
        for (let i = 0; i < imgCnt; i++) {
          // 画像サイズに掛けるアスペクト比を0.5~1.5倍でランダムで生成
          aspect = Math.random() * (aspectMax - aspectMin) + aspectMin
          aryImg.push({
            posx: Math.random() * cvsw, // 初期表示位置x
            posy: Math.random() * cvsh, // 初期表示位置y
            sizew: imgBaseSizeW * aspect, // 画像の横幅
            sizeh: imgBaseSizeH * aspect, // 画像の縦幅
            speedy: Math.random() * (speedMax - speedMin) + speedMin, // 画像が落ちていく速度
            angle: Math.random() * 360 // 角度
          })
        }
      }

      // 描画、パラメーターの更新
      let idx = 0
      let cos = 0
      let sin = 0
      let rad = Math.PI / 180
      function flow() {
        ctx.clearRect(0, 0, cvsw, cvsh)
        for (idx = 0; idx < imgCnt; idx++) {
          aryImg[idx].posy += aryImg[idx].speedy
          aryImg[idx].angle += Math.random() * angleAdd
          cos = Math.cos(aryImg[idx].angle * rad)
          sin = Math.sin(aryImg[idx].angle * rad)
          ctx.setTransform(
            cos,
            sin,
            sin,
            cos,
            aryImg[idx].posx,
            aryImg[idx].posy
          )
          ctx.drawImage(img, 0, 0, aryImg[idx].sizew, aryImg[idx].sizeh)
          ctx.setTransform(1, 0, 0, 1, 0, 0)
          // 範囲外に描画された画像を上に戻す
          if (aryImg[idx].posy >= cvsh) {
            aryImg[idx].posy = -aryImg[idx].sizeh
          }
        }
      }

      function flow_start() {
        this.fallImage = new Image()
        setImagas()
        clearInterval(this.flowImage)
        this.flowImage = 0
        this.flowImage = setInterval(flow, 10)
      }
    },
    handleResize() {
      this.cvsw = window.innerWidth
    }
  }
}
</script>
<style lang="sass" scoped>
#cvs
  background-color: transparent
  // background-image: url("../../assets/img/yozora.jpg")
.st0
  stroke: red
</style>
